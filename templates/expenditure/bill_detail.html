<!--
-------------------------------------------------------------------------
System: KP-CFMS (Computerized Financial Management System)
Client: Local Government Department, Khyber Pakhtunkhwa
Team Lead: Jamil Shah
Developers: Ali Asghar, Akhtar Munir and Zarif Khan
Description: Bill Detail Template with Workflow Actions
-------------------------------------------------------------------------
-->
{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block title %}Bill #{{ bill.id }} - KP-CFMS{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'budgeting:dashboard' %}">Home</a></li>
        <li class="breadcrumb-item"><a href="{% url 'expenditure:dashboard' %}">Expenditure</a></li>
        <li class="breadcrumb-item"><a href="{% url 'expenditure:bill_list' %}">Bills</a></li>
        <li class="breadcrumb-item active">Bill #{{ bill.id }}</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <!-- Bill Header -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-receipt"></i> Bill #{{ bill.id }}
                </h5>
                <div>
                    {% if bill.status == 'DRAFT' %}
                    <span class="badge bg-secondary badge-status">Draft</span>
                    {% elif bill.status == 'SUBMITTED' %}
                    <span class="badge bg-warning text-dark badge-status">Submitted</span>
                    {% elif bill.status == 'APPROVED' %}
                    <span class="badge bg-success badge-status">Approved</span>
                    {% elif bill.status == 'PAID' %}
                    <span class="badge bg-primary badge-status">Paid</span>
                    {% elif bill.status == 'REJECTED' %}
                    <span class="badge bg-danger badge-status">Rejected</span>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Fiscal Year:</strong><br>
                        {{ bill.fiscal_year.year_name }}
                    </div>
                    <div class="col-md-6">
                        <strong>Bill Date:</strong><br>
                        {{ bill.bill_date|date:"d-M-Y" }}
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Payee:</strong><br>
                        {{ bill.payee.name }}
                        {% if bill.payee.cnic_ntn %}
                        <small class="text-muted">({{ bill.payee.cnic_ntn }})</small>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <strong>Vendor Invoice #:</strong><br>
                        {{ bill.bill_number }}
                    </div>
                </div>
                
                <div class="mb-3">
                    <strong>Bill Items:</strong>
                    <table class="table table-sm table-bordered mt-2">
                        <thead class="table-light">
                            <tr>
                                <th>Head</th>
                                <th>Description</th>
                                <th class="text-end">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for line in bill.lines.all %}
                            <tr>
                                <td>{{ line.budget_head.code }} - {{ line.budget_head.name }}</td>
                                <td>{{ line.description }}</td>
                                <td class="text-end">Rs. {{ line.amount|currency }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <div class="mb-3">
                    <strong>Description:</strong><br>
                    {{ bill.description }}
                </div>
            </div>
        </div>
        
        <!-- Amount Details -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-calculator"></i> Amount Details</h6>
            </div>
            <div class="card-body">
                <table class="table table-bordered mb-0">
                    <tr>
                        <th width="50%">Gross Amount</th>
                        <td class="text-end">Rs. {{ bill.gross_amount|currency }}</td>
                    </tr>
                    <tr>
                        <th>Tax Deduction</th>
                        <td class="text-end text-danger">(-) Rs. {{ bill.tax_amount|currency }}</td>
                    </tr>
                    <tr class="table-success">
                        <th>Net Payable</th>
                        <td class="text-end fw-bold">Rs. {{ bill.net_amount|currency }}</td>
                    </tr>
                </table>
            </div>
        </div>
        
        <!-- Budget Allocation Info -->
        {% if line_allocations %}
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-graph-up"></i> Budget Status (Per Head)</h6>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-sm table-striped mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Budget Head</th>
                                <th class="text-end">Released</th>
                                <th class="text-end">Spent</th>
                                <th class="text-end">Available</th>
                                <th style="width: 25%">Utilization</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in line_allocations %}
                            {% with alloc=item.allocation line=item.line %}
                            <tr>
                                <td>
                                    <small class="d-block fw-bold">{{ line.budget_head.code }}</small>
                                    <small class="text-muted">{{ line.budget_head.name|truncatechars:20 }}</small>
                                </td>
                                {% if alloc %}
                                <td class="text-end align-middle">{{ alloc.released_amount|currency }}</td>
                                <td class="text-end text-danger align-middle">{{ alloc.spent_amount|currency }}</td>
                                <td class="text-end text-success align-middle">{{ alloc.get_available_budget|currency }}</td>
                                <td class="align-middle">
                                    {% if alloc.released_amount > 0 %}
                                    <div class="progress" style="height: 15px;">
                                        <div class="progress-bar" role="progressbar" 
                                             style="width: {% widthratio alloc.spent_amount alloc.released_amount 100 %}%"
                                             aria-valuenow="{% widthratio alloc.spent_amount alloc.released_amount 100 %}" 
                                             aria-valuemin="0" aria-valuemax="100">
                                            {% widthratio alloc.spent_amount alloc.released_amount 100 %}%
                                        </div>
                                    </div>
                                    {% else %}
                                    <span class="badge bg-secondary">No Budget</span>
                                    {% endif %}
                                </td>
                                {% else %}
                                <td colspan="4" class="text-center text-muted align-middle">No allocation found</td>
                                {% endif %}
                            </tr>
                            {% endwith %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- GL Voucher Info -->
        {% if bill.liability_voucher %}
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-journal-text"></i> GL Voucher</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <strong>Voucher No:</strong><br>
                        {{ bill.liability_voucher.voucher_no }}
                    </div>
                    <div class="col-md-6">
                        <strong>Posted:</strong><br>
                        {{ bill.liability_voucher.posted_at|date:"d-M-Y H:i" }} by {{ bill.liability_voucher.posted_by }}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Payments -->
        {% if payments %}
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-credit-card"></i> Payments</h6>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Cheque #</th>
                            <th>Date</th>
                            <th>Bank Account</th>
                            <th>Amount</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for payment in payments %}
                        <tr>
                            <td>{{ payment.cheque_number }}</td>
                            <td>{{ payment.cheque_date|date:"d-M-Y" }}</td>
                            <td>{{ payment.bank_account.bank_name }}</td>
                            <td>Rs. {{ payment.amount|currency }}</td>
                            <td>
                                {% if payment.is_posted %}
                                <span class="badge bg-success">Posted</span>
                                {% else %}
                                <span class="badge bg-warning">Pending</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
        
        <!-- Rejection Info -->
        {% if bill.status == 'REJECTED' %}
        <div class="alert alert-danger">
            <h6><i class="bi bi-x-octagon"></i> Bill Rejected</h6>
            <p class="mb-1"><strong>Rejected By:</strong> {{ bill.rejected_by }}</p>
            <p class="mb-1"><strong>Date:</strong> {{ bill.rejected_at|date:"d-M-Y H:i" }}</p>
            <p class="mb-0"><strong>Reason:</strong> {{ bill.rejection_reason }}</p>
        </div>
        {% endif %}
    </div>
    
    <!-- Action Sidebar -->
    <div class="col-lg-4">
        <!-- Workflow Actions -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-lightning"></i> Actions</h6>
            </div>
            <div class="card-body">
                {% if can_submit %}
                <form method="post" action="{% url 'expenditure:bill_submit' bill.pk %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-warning w-100 mb-2" 
                            onclick="return confirm('Submit this bill for approval?');">
                        <i class="bi bi-send"></i> Submit for Approval
                    </button>
                </form>
                {% endif %}
                
                {% if can_approve %}
                <div class="card bg-light mb-3">
                    <div class="card-body">
                        <h6 class="card-title">Approval Decision</h6>
                        <form method="post" action="{% url 'expenditure:bill_approve' bill.pk %}">
                            {% csrf_token %}
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="action" 
                                           id="action_approve" value="approve" checked>
                                    <label class="form-check-label" for="action_approve">
                                        <i class="bi bi-check-circle text-success"></i> Approve
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="action" 
                                           id="action_reject" value="reject">
                                    <label class="form-check-label" for="action_reject">
                                        <i class="bi bi-x-circle text-danger"></i> Reject
                                    </label>
                                </div>
                            </div>
                            <div class="mb-3" id="rejection_reason_div" style="display: none;">
                                <label class="form-label">Rejection Reason</label>
                                <textarea name="rejection_reason" class="form-control" rows="3"></textarea>
                            </div>
                            <button type="submit" class="btn btn-cfms w-100">
                                <i class="bi bi-check-lg"></i> Submit Decision
                            </button>
                        </form>
                    </div>
                </div>
                {% endif %}
                
                {% if can_pay %}
                <a href="{% url 'expenditure:payment_create_for_bill' bill.pk %}" 
                   class="btn btn-success w-100 mb-2">
                    <i class="bi bi-credit-card"></i> Issue Payment
                </a>
                {% endif %}
                
                <a href="{% url 'expenditure:bill_list' %}" class="btn btn-outline-secondary w-100">
                    <i class="bi bi-arrow-left"></i> Back to List
                </a>
            </div>
        </div>
        
        <!-- Audit Trail -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-clock-history"></i> Audit Trail</h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li class="mb-2">
                        <small class="text-muted">Created</small><br>
                        {{ bill.created_at|date:"d-M-Y H:i" }}
                        {% if bill.created_by %} by {{ bill.created_by }}{% endif %}
                    </li>
                    {% if bill.submitted_at %}
                    <li class="mb-2">
                        <small class="text-muted">Submitted</small><br>
                        {{ bill.submitted_at|date:"d-M-Y H:i" }}
                        {% if bill.submitted_by %} by {{ bill.submitted_by }}{% endif %}
                    </li>
                    {% endif %}
                    {% if bill.approved_at %}
                    <li class="mb-2">
                        <small class="text-muted">Approved</small><br>
                        {{ bill.approved_at|date:"d-M-Y H:i" }}
                        {% if bill.approved_by %} by {{ bill.approved_by }}{% endif %}
                    </li>
                    {% endif %}
                    <li>
                        <small class="text-muted">Last Updated</small><br>
                        {{ bill.updated_at|date:"d-M-Y H:i" }}
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Toggle rejection reason field
    document.querySelectorAll('input[name="action"]').forEach(function(radio) {
        radio.addEventListener('change', function() {
            const reasonDiv = document.getElementById('rejection_reason_div');
            if (this.value === 'reject') {
                reasonDiv.style.display = 'block';
            } else {
                reasonDiv.style.display = 'none';
            }
        });
    });
</script>
{% endblock %}
