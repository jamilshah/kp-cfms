{% extends "base.html" %}
{% load humanize %}

{% block title %}Sub-Head Management - KP-CFMS{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">
                        <i class="bi bi-diagram-3 me-2"></i>Sub-Head Management
                    </h2>
                    <p class="text-muted mb-0">
                        Level 5: Optional subdivisions of NAM Heads for granular tracking
                    </p>
                </div>
                <div>
                    <a href="{% url 'finance:coa_hub' %}" class="btn btn-outline-secondary me-2">
                        <i class="bi bi-arrow-left me-1"></i> CoA Hub
                    </a>
                    <a href="{% url 'finance:subhead_create' %}" class="btn btn-primary">
                        <i class="bi bi-plus-circle me-1"></i> Create Sub-Head
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Info Alert -->
    <div class="alert alert-info mb-4">
        <div class="d-flex align-items-start">
            <i class="bi bi-info-circle-fill fs-4 me-3 mt-1"></i>
            <div>
                <strong>About Sub-Heads:</strong>
                <p class="mb-1 mt-1">
                    Sub-Heads provide optional Level 5 subdivisions of NAM Heads (Level 4) for more detailed internal tracking.
                    When sub-heads are created under a NAM Head, that NAM Head becomes rollup-only (no direct posting).
                </p>
                <small><strong>Example:</strong> A01101 (Basic Pay) â†’ A01101-01, A01101-02, A01101-03...</small>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted mb-2">Total Sub-Heads</h6>
                    <h3 class="mb-0">{{ total_count|intcomma }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm border-success">
                <div class="card-body">
                    <h6 class="text-muted mb-2">Active</h6>
                    <h3 class="mb-0 text-success">{{ active_count|intcomma }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm border-secondary">
                <div class="card-body">
                    <h6 class="text-muted mb-2">Inactive</h6>
                    <h3 class="mb-0 text-secondary">{{ inactive_count|intcomma }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm border-info">
                <div class="card-body">
                    <h6 class="text-muted mb-2">NAM Heads with Subs</h6>
                    <h3 class="mb-0 text-info">{{ nam_heads_with_subs|intcomma }}</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Parent NAM Head</label>
                    <select name="nam_head" class="form-select">
                        <option value="">All NAM Heads</option>
                        {% for nam in nam_heads %}
                        <option value="{{ nam.id }}" {% if selected_nam_head == nam.id|stringformat:"s" %}selected{% endif %}>
                            {{ nam.code }} - {{ nam.name|truncatewords:5 }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-2">
                    <label class="form-label">Account Type</label>
                    <select name="account_type" class="form-select">
                        <option value="">All Types</option>
                        {% for code, name in account_types %}
                        <option value="{{ code }}" {% if selected_account_type == code %}selected{% endif %}>
                            {{ name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-2">
                    <label class="form-label">Status</label>
                    <select name="status" class="form-select">
                        <option value="">All</option>
                        <option value="active" {% if selected_status == 'active' %}selected{% endif %}>Active</option>
                        <option value="inactive" {% if selected_status == 'inactive' %}selected{% endif %}>Inactive</option>
                    </select>
                </div>
                
                <div class="col-md-4">
                    <label class="form-label">Search</label>
                    <input type="text" name="search" class="form-control" 
                           placeholder="Code or name..." value="{{ search_query }}">
                </div>
                
                <div class="col-md-1 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-funnel"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Sub-Heads Table -->
    <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th class="px-4 py-3">Sub-Head Code</th>
                            <th>Name</th>
                            <th>Parent NAM Head</th>
                            <th>Account Type</th>
                            <th class="text-center">Status</th>
                            <th class="text-end px-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for subhead in subheads %}
                        <tr>
                            <td class="px-4">
                                <code class="fs-6">{{ subhead.code }}</code>
                            </td>
                            <td>
                                <strong>{{ subhead.name }}</strong>
                                {% if subhead.description %}
                                <br><small class="text-muted">{{ subhead.description|truncatewords:10 }}</small>
                                {% endif %}
                            </td>
                            <td>
                                <code>{{ subhead.nam_head.code }}</code>
                                <br><small class="text-muted">{{ subhead.nam_head.name|truncatewords:5 }}</small>
                            </td>
                            <td>
                                {% if subhead.nam_head.account_type == 'EXP' %}
                                <span class="badge bg-danger">Expenditure</span>
                                {% elif subhead.nam_head.account_type == 'REV' %}
                                <span class="badge bg-success">Revenue</span>
                                {% elif subhead.nam_head.account_type == 'AST' %}
                                <span class="badge bg-primary">Asset</span>
                                {% elif subhead.nam_head.account_type == 'LIA' %}
                                <span class="badge bg-warning text-dark">Liability</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {% if subhead.is_active %}
                                <span class="badge bg-success">Active</span>
                                {% else %}
                                <span class="badge bg-secondary">Inactive</span>
                                {% endif %}
                            </td>
                            <td class="text-end px-4">
                                <a href="{% url 'finance:subhead_edit' subhead.pk %}" 
                                   class="btn btn-sm btn-outline-primary"
                                   title="Edit">
                                    <i class="bi bi-pencil"></i>
                                </a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center py-5 text-muted">
                                <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                No sub-heads found
                                {% if search_query or selected_nam_head or selected_account_type or selected_status %}
                                matching your filters.
                                <br>
                                <a href="{% url 'finance:subhead_list' %}" class="btn btn-sm btn-outline-secondary mt-2">
                                    Clear Filters
                                </a>
                                {% else %}
                                . Create your first sub-head to get started.
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pagination -->
        {% if is_paginated %}
        <div class="card-footer bg-white border-top">
            <nav>
                <ul class="pagination justify-content-center mb-0">
                    {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1{{ query_string }}">First</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{{ query_string }}">Previous</a>
                    </li>
                    {% endif %}

                    <li class="page-item active">
                        <span class="page-link">
                            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                        </span>
                    </li>

                    {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}{{ query_string }}">Next</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{{ query_string }}">Last</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
