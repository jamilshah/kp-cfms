{% extends 'base.html' %}
{% load humanize %}

{% block title %}Budget Head Department Assignment - KP-CFMS{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col">
            <h2><i class="bi bi-building-gear"></i> Budget Head Department Assignment</h2>
            <p class="text-muted">
                Assign each budget head to a department for filtering and access control.
                Budget heads without departments cannot be used in budget estimates.
            </p>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted mb-2">Total Budget Heads</h6>
                    <h3 class="mb-0">{{ total_heads|intcomma }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm border-success">
                <div class="card-body">
                    <h6 class="text-muted mb-2">Assigned</h6>
                    <h3 class="mb-0 text-success">{{ assigned_count|intcomma }}</h3>
                    <small class="text-muted">{{ assigned_count|floatformat:0 }}/{{ total_heads }} ({% widthratio assigned_count total_heads 100 %}%)</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm border-warning">
                <div class="card-body">
                    <h6 class="text-muted mb-2">Unmapped</h6>
                    <h3 class="mb-0 text-warning">{{ unmapped_count|intcomma }}</h3>
                    <small class="text-muted">Need department assignment</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Unmapped Functions Alert -->
    {% if unmapped_functions %}
    <div class="alert alert-warning mb-4">
        <h6 class="alert-heading"><i class="bi bi-exclamation-triangle"></i> Functions with Unmapped Budget Heads</h6>
        <div class="row">
            {% for func in unmapped_functions %}
            <div class="col-md-6 mb-2">
                <strong>{{ func.function__code }}</strong> - {{ func.function__name|truncatewords:5 }}
                <span class="badge bg-warning text-dark ms-2">{{ func.count }} head{{ func.count|pluralize }}</span>
                <a href="?function={{ func.function__code }}&department=UNMAPPED" class="ms-2">Filter →</a>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Filters -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-2">
                    <label class="form-label">Function</label>
                    <select name="function" class="form-select">
                        <option value="">All Functions</option>
                        {% for func in functions %}
                        <option value="{{ func.id }}" {% if selected_function == func.id|stringformat:"s" %}selected{% endif %}>
                            {{ func.code }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Account Type</label>
                    <select name="account_type" class="form-select">
                        <option value="">All Types</option>
                        {% for code, label in account_types %}
                        <option value="{{ code }}" {% if selected_account_type == code %}selected{% endif %}>
                            {{ label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Department</label>
                    <select name="department" class="form-select">
                        <option value="">All</option>
                        <option value="UNMAPPED" {% if selected_department == 'UNMAPPED' %}selected{% endif %}>⚠️ Unmapped</option>
                        {% for dept in departments %}
                        <option value="{{ dept.id }}" {% if selected_department == dept.id|stringformat:"s" %}selected{% endif %}>
                            {{ dept.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Search</label>
                    <input type="text" name="search" class="form-control" 
                           placeholder="Code or name" value="{{ search_query }}">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-search"></i> Filter
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Bulk Actions Form -->
    <form method="post" id="bulkForm">
        {% csrf_token %}
        <input type="hidden" name="action" value="bulk_assign">
        
        <div class="card border-0 shadow-sm mb-3">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <label class="form-label mb-0">Bulk Assign Selected to:</label>
                        <select name="bulk_department" class="form-select" required>
                            <option value="">-- Select Department --</option>
                            {% for dept in departments %}
                            <option value="{{ dept.id }}">{{ dept.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-check-lg"></i> Assign Selected
                        </button>
                    </div>
                    <div class="col-md-3 text-end">
                        <label class="form-check-label">
                            <input type="checkbox" id="selectAll" class="form-check-input"> Select All
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Budget Heads Table -->
        <div class="card border-0 shadow-sm">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 40px">
                                    <input type="checkbox" onclick="toggleAllCheckboxes(this)">
                                </th>
                                <th style="width: 120px">Code</th>
                                <th>Name</th>
                                <th style="width: 100px">Function</th>
                                <th style="width: 80px">Type</th>
                                <th style="width: 150px">Current Department</th>
                                <th style="width: 200px">Assign To</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for head in budget_heads %}
                            <tr>
                                <td>
                                    <input type="checkbox" name="selected_heads" value="{{ head.id }}" 
                                           class="form-check-input head-checkbox">
                                </td>
                                <td><code class="small">{{ head.code }}</code></td>
                                <td class="small">{{ head.name|truncatewords:10 }}</td>
                                <td><code class="small">{{ head.function.code }}</code></td>
                                <td>
                                    <span class="badge badge-sm bg-{{ head.global_head.account_type|lower }}">
                                        {{ head.global_head.account_type }}
                                    </span>
                                </td>
                                <td>
                                    {% if head.department %}
                                        <span class="badge bg-secondary">{{ head.department.name|truncatewords:2 }}</span>
                                    {% else %}
                                        <span class="badge bg-warning text-dark"><i class="bi bi-exclamation-triangle"></i> Unmapped</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <form method="post" class="d-inline-flex w-100" onsubmit="return confirm('Assign this budget head?');">
                                        {% csrf_token %}
                                        <input type="hidden" name="action" value="assign_single">
                                        <input type="hidden" name="head_id" value="{{ head.id }}">
                                        <select name="department" class="form-select form-select-sm me-1" required>
                                            <option value="">-- Select --</option>
                                            {% for dept in departments %}
                                            <option value="{{ dept.id }}" {% if head.department.id == dept.id %}selected{% endif %}>
                                                {{ dept.name|truncatewords:2 }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                        <button type="submit" class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-check"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="text-center text-muted py-4">
                                    No budget heads found matching your filters.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Pagination -->
            {% if is_paginated %}
            <div class="card-footer">
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center mb-0">
                        {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1{{ query_string }}">First</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{{ query_string }}">Previous</a>
                        </li>
                        {% endif %}

                        <li class="page-item active">
                            <span class="page-link">
                                Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                            </span>
                        </li>

                        {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}{{ query_string }}">Next</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{{ query_string }}">Last</a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
            {% endif %}
        </div>
    </form>
</div>

<script>
// Select all checkboxes
document.getElementById('selectAll').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.head-checkbox');
    checkboxes.forEach(cb => cb.checked = this.checked);
});

function toggleAllCheckboxes(source) {
    const checkboxes = document.querySelectorAll('.head-checkbox');
    checkboxes.forEach(cb => cb.checked = source.checked);
    document.getElementById('selectAll').checked = source.checked;
}

// Validate bulk form
document.getElementById('bulkForm').addEventListener('submit', function(e) {
    const selected = document.querySelectorAll('.head-checkbox:checked');
    if (selected.length === 0) {
        e.preventDefault();
        alert('Please select at least one budget head');
        return false;
    }
    
    const dept = document.querySelector('select[name="bulk_department"]').value;
    if (!dept) {
        e.preventDefault();
        alert('Please select a department');
        return false;
    }
    
    return confirm(`Assign ${selected.length} budget head(s) to the selected department?`);
});
</script>
{% endblock %}
