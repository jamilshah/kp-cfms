{% extends "base.html" %}

{% block title %}Chart of Accounts - KP-CFMS{% endblock %}

{% block extra_css %}
<style>
    .tree-row {
        transition: background-color 0.15s ease;
    }
    .tree-row:hover {
        background-color: #f8f9fa;
    }
    .tree-toggle {
        cursor: pointer;
        user-select: none;
        color: #6c757d;
        width: 20px;
        display: inline-block;
        text-align: center;
    }
    .tree-toggle:hover {
        color: #0d6efd;
    }
    .tree-toggle.collapsed::before {
        content: "▸";
    }
    .tree-toggle.expanded::before {
        content: "▾";
    }
    .tree-node-collapsed {
        display: none;
    }
    .filter-section {
        background-color: #f8f9fa;
        border-radius: 0.375rem;
        padding: 1rem;
    }
    .badge-type-exp { background-color: #dc3545; color: #fff; }
    .badge-type-rev { background-color: #198754; color: #fff; }
    .badge-type-lia { background-color: #ffc107; color: #000; }
    .badge-type-ast { background-color: #0dcaf0; color: #000; }
    .badge-type-eqt { background-color: #6c757d; color: #fff; }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-1"><i class="bi bi-diagram-3"></i> Chart of Accounts</h2>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="{% url 'budgeting:setup_dashboard' %}">Setup</a></li>
                <li class="breadcrumb-item active">CoA</li>
            </ol>
        </nav>
    </div>
    <div>
        <button type="button" class="btn btn-outline-secondary me-2" id="expandAllBtn">
            <i class="bi bi-arrows-expand"></i> Expand All
        </button>
        <button type="button" class="btn btn-outline-secondary me-2" id="collapseAllBtn">
            <i class="bi bi-arrows-collapse"></i> Collapse All
        </button>
        <a href="{% url 'budgeting:setup_coa_add' %}" class="btn btn-primary">
            <i class="bi bi-plus-lg"></i> Add Budget Head
        </a>
    </div>
</div>

<!-- Filters Section -->
<div class="filter-section mb-4">
    <form method="get" id="filterForm">
        <div class="row g-3">
            <!-- Row 1: Primary Context -->
            <div class="col-md-3">
                <label class="form-label fw-bold small text-muted">SEARCH</label>
                <div class="input-group">
                    <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
                    <input type="text" name="q" class="form-control border-start-0 ps-0" placeholder="Search Code or Description..." value="{{ request.GET.q|default:'' }}">
                </div>
            </div>
            <div class="col-md-3">
                <label class="form-label fw-bold small text-muted">DEPARTMENT</label>
                <select name="department" class="form-select">
                    <option value="">All Departments</option>
                    {% for dept in departments %}
                    <option value="{{ dept.id }}" {% if request.GET.department|add:0 == dept.id %}selected{% endif %}>{{ dept.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label fw-bold small text-muted">FUNCTION</label>
                <select name="function" class="form-select">
                    <option value="">All Functions</option>
                    {% for func in functions %}
                    <option value="{{ func.id }}" {% if request.GET.function|add:0 == func.id %}selected{% endif %}>{{ func.code }} - {{ func.name|truncatechars:30 }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label fw-bold small text-muted">FUND</label>
                <select name="fund" class="form-select">
                    <option value="">All Funds</option>
                    {% for fund in funds %}
                    <option value="{{ fund.id }}" {% if request.GET.fund|add:0 == fund.id %}selected{% endif %}>{{ fund.code }} - {{ fund.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Row 2: Attributes -->
            <div class="col-md-2">
                <label class="form-label fw-bold small text-muted">ACCOUNT TYPE</label>
                <select name="account_type" class="form-select form-select-sm">
                    <option value="">All Types</option>
                    {% for value, label in account_types %}
                    <option value="{{ value }}" {% if request.GET.account_type == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label fw-bold small text-muted">MAJOR HEAD</label>
                <select name="major_head" class="form-select form-select-sm">
                    <option value="">All</option>
                    {% for major in major_heads %}
                    <option value="{{ major }}" {% if request.GET.major_head == major %}selected{% endif %}>{{ major }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label fw-bold small text-muted">MINOR HEAD</label>
                <select name="minor_head" class="form-select form-select-sm">
                    <option value="">All</option>
                    {% for minor in minor_heads %}
                    <option value="{{ minor }}" {% if request.GET.minor_head == minor %}selected{% endif %}>{{ minor }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label fw-bold small text-muted">STATUS</label>
                <select name="is_active" class="form-select form-select-sm">
                    <option value="">All</option>
                    <option value="true" {% if request.GET.is_active == 'true' %}selected{% endif %}>Active Only</option>
                    <option value="false" {% if request.GET.is_active == 'false' %}selected{% endif %}>Inactive Only</option>
                </select>
            </div>
            <div class="col-md-4 d-flex align-items-end gap-2">
                <button type="submit" class="btn btn-primary flex-grow-1">
                    <i class="bi bi-funnel"></i> Apply Filters
                </button>
                {% if request.GET.q or request.GET.account_type or request.GET.fund or request.GET.function or request.GET.is_active or request.GET.major_head or request.GET.minor_head or request.GET.department %}
                <a href="{% url 'budgeting:setup_coa_list' %}" class="btn btn-outline-secondary" title="Clear Filters">
                    <i class="bi bi-x-lg"></i>
                </a>
                {% endif %}
            </div>
        </div>
    </form>
</div>

<div class="card shadow-sm">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <span class="fw-semibold">
            <i class="bi bi-table"></i> Budget Heads 
            {% if is_paginated %}
                <span class="badge bg-secondary ms-2">{{ page_obj.paginator.count }} total</span>
                <span class="badge bg-info ms-1">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
            {% else %}
                <span class="badge bg-secondary ms-2">{{ tree_nodes|length }}</span>
            {% endif %}
        </span>
    </div>
    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0" id="coaTree">
            <thead class="table-light">
                <tr>
                    <th style="width: 50%;">Object Code / Description</th>
                    <th style="width: 15%;">Fund</th>
                    <th style="width: 15%;">Type</th>
                    <th class="text-center" style="width: 10%;">Status</th>
                    <th class="text-end" style="width: 10%;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for node in tree_nodes %}
                {% if node.is_group_header %}
                    <!-- Function Group Header -->
                    <tr class="tree-row table-light fw-bold" data-level="0" data-code="{{ node.obj.code }}" data-parent="">
                        <td colspan="5">
                            <i class="bi bi-folder2-open text-primary me-2"></i>
                            <span class="tree-toggle expanded" data-code="{{ node.obj.code }}"></span>
                            {{ node.group_name }}
                        </td>
                    </tr>
                {% else %}
                    <!-- Budget Head Row -->
                    {% with head=node.obj %}
                    <tr class="tree-row" data-level="1" data-code="{{ head.code }}" data-parent="{{ node.parent_code }}">
                        <td>
                            <div style="padding-left: 2.5rem; display: flex; align-items: center;">
                                <i class="bi bi-file-earmark-text text-muted me-2"></i>
                                <div>
                                    <code class="text-primary fw-semibold">{{ head.code }}</code>
                                    <div class="small text-muted mt-1">{{ head.name|truncatewords:15 }}</div>
                                </div>
                            </div>
                        </td>
                        <td><span class="badge bg-light text-dark border">{{ head.fund.code }}</span></td>
                        <td>
                            <span class="badge badge-type-{{ head.global_head.account_type|lower }}">
                                {{ head.global_head.get_account_type_display }}
                            </span>
                        </td>
                        <td class="text-center">
                            <div class="form-check form-switch d-inline-block">
                                <input class="form-check-input status-toggle" type="checkbox" 
                                       role="switch" 
                                       id="statusSwitch{{ head.pk }}" 
                                       data-head-id="{{ head.pk }}"
                                       {% if head.is_active %}checked{% endif %}>
                            </div>
                        </td>
                        <td class="text-end">
                            <div class="btn-group btn-group-sm">
                                <a href="{% url 'budgeting:setup_coa_edit' head.pk %}" class="btn btn-outline-primary" title="Edit">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <a href="{% url 'budgeting:setup_coa_delete' head.pk %}" class="btn btn-outline-danger" title="Delete" onclick="return confirm('Delete this budget head?')">
                                    <i class="bi bi-trash"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endwith %}
                {% endif %}
                {% empty %}
                <tr>
                    <td colspan="7" class="text-center py-5 text-muted">
                        <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                        <div class="mt-2">No budget heads found matching your filters.</div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Pagination -->
    {% if is_paginated %}
    <div class="card-footer">
        <div class="d-flex justify-content-between align-items-center">
            <div class="text-muted">
                Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ page_obj.paginator.count }} budget heads
            </div>
            <nav aria-label="Budget head pagination">
                <ul class="pagination pagination-sm mb-0">
                    {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                            <i class="bi bi-chevron-bar-left"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                            <i class="bi bi-chevron-left"></i>
                        </a>
                    </li>
                    {% else %}
                    <li class="page-item disabled">
                        <span class="page-link"><i class="bi bi-chevron-bar-left"></i></span>
                    </li>
                    <li class="page-item disabled">
                        <span class="page-link"><i class="bi bi-chevron-left"></i></span>
                    </li>
                    {% endif %}
                    
                    {% for num in page_obj.paginator.page_range %}
                        {% if num == page_obj.number %}
                        <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                {{ num }}
                            </a>
                        </li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                            <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                            <i class="bi bi-chevron-bar-right"></i>
                        </a>
                    </li>
                    {% else %}
                    <li class="page-item disabled">
                        <span class="page-link"><i class="bi bi-chevron-right"></i></span>
                    </li>
                    <li class="page-item disabled">
                        <span class="page-link"><i class="bi bi-chevron-bar-right"></i></span>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tree = document.getElementById('coaTree');
    if (!tree) return;
    
    // Toggle tree node
    function toggleNode(code, expand) {
        const rows = tree.querySelectorAll('tr[data-parent="' + code + '"]');
        rows.forEach(row => {
            const isCurrentlyHidden = row.classList.contains('tree-node-collapsed');
            
            if (expand && isCurrentlyHidden) {
                row.classList.remove('tree-node-collapsed');
            } else if (!expand && !isCurrentlyHidden) {
                row.classList.add('tree-node-collapsed');
                // Also collapse all descendants
                const childCode = row.dataset.code;
                toggleNode(childCode, false);
            }
        });
        
        // Update toggle icon
        const toggle = tree.querySelector('.tree-toggle[data-code="' + code + '"]');
        if (toggle) {
            if (expand) {
                toggle.classList.remove('collapsed');
                toggle.classList.add('expanded');
            } else {
                toggle.classList.remove('expanded');
                toggle.classList.add('collapsed');
            }
        }
    }
    
    // Attach click handlers to toggle buttons
    tree.querySelectorAll('.tree-toggle').forEach(toggle => {
        toggle.addEventListener('click', function(e) {
            e.stopPropagation();
            const code = this.dataset.code;
            const isExpanded = this.classList.contains('expanded');
            toggleNode(code, !isExpanded);
        });
    });
    
    // Expand all button
    document.getElementById('expandAllBtn')?.addEventListener('click', function() {
        tree.querySelectorAll('.tree-node-collapsed').forEach(row => {
            row.classList.remove('tree-node-collapsed');
        });
        tree.querySelectorAll('.tree-toggle').forEach(toggle => {
            toggle.classList.remove('collapsed');
            toggle.classList.add('expanded');
        });
    });
    
    // Collapse all button
    document.getElementById('collapseAllBtn')?.addEventListener('click', function() {
        // Collapse all except level 0
        tree.querySelectorAll('tr[data-level]').forEach(row => {
            const level = parseInt(row.dataset.level);
            if (level > 0) {
                row.classList.add('tree-node-collapsed');
            }
        });
        tree.querySelectorAll('.tree-toggle').forEach(toggle => {
            toggle.classList.remove('expanded');
            toggle.classList.add('collapsed');
        });
    });
    
    // Auto-submit on filter change
    const filterSelects = document.querySelectorAll('#filterForm select');
    filterSelects.forEach(select => {
        select.addEventListener('change', function() {
            document.getElementById('filterForm').submit();
        });
    });
});
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Event delegation for status toggles
        document.body.addEventListener('change', function(e) {
            if (e.target.classList.contains('status-toggle')) {
                const toggle = e.target;
                const headId = toggle.dataset.headId;
                const isChecked = toggle.checked;
                
                // Disable to prevent multiple clicks
                toggle.disabled = true;

                // Use a safe placeholder that won't conflict with other parts of the URL
                // We use '999999' as a dummy ID for the reverse lookup
                const urlPattern = "{% url 'budgeting:setup_coa_toggle_status' 999999 %}";
                const url = urlPattern.replace('999999', headId);
                
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok: ' + response.status + ' ' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        showToast(data.message || 'Status updated successfully');
                    } else {
                        throw new Error(data.message || 'Server returned error');
                    }
                })
                .catch(error => {
                    console.error('Toggle Error:', error);
                    // Revert state
                    toggle.checked = !isChecked;
                    alert('Failed to update status: ' + error.message);
                })
                .finally(() => {
                    toggle.disabled = false;
                });
            }
        });

        function showToast(message) {
            let container = document.getElementById('toastRequestDetails');
            if (!container) {
                container = document.createElement('div');
                container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
                container.style.zIndex = '1050';
                container.id = 'toastRequestDetails';
                document.body.appendChild(container);
            }
            
            const toastHtml = `
                <div class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', toastHtml);
            const toastEl = container.lastElementChild;
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
        }
    });
</script>
{% endblock %}
