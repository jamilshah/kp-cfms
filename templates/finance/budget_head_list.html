{% extends "base.html" %}

{% block title %}Chart of Accounts - KP-CFMS{% endblock %}

{% block extra_css %}
<style>
    .tree-row {
        transition: background-color 0.15s ease;
    }
    .tree-row:hover {
        background-color: #f8f9fa;
    }
    .tree-toggle {
        cursor: pointer;
        user-select: none;
        color: #6c757d;
        width: 20px;
        display: inline-block;
        text-align: center;
    }
    .tree-toggle:hover {
        color: #0d6efd;
    }
    .tree-toggle.collapsed::before {
        content: "▸";
    }
    .tree-toggle.expanded::before {
        content: "▾";
    }
    .tree-node-collapsed {
        display: none;
    }
    .filter-section {
        background-color: #f8f9fa;
        border-radius: 0.375rem;
        padding: 1rem;
    }
    .badge-type-exp { background-color: #dc3545; color: #fff; }
    .badge-type-rev { background-color: #198754; color: #fff; }
    .badge-type-lia { background-color: #ffc107; color: #000; }
    .badge-type-ast { background-color: #0dcaf0; color: #000; }
    .badge-type-eqt { background-color: #6c757d; color: #fff; }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-1"><i class="bi bi-diagram-3"></i> Chart of Accounts</h2>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="{% url 'budgeting:setup_dashboard' %}">Setup</a></li>
                <li class="breadcrumb-item active">CoA</li>
            </ol>
        </nav>
    </div>
    <div>
        <button type="button" class="btn btn-outline-secondary me-2" id="expandAllBtn">
            <i class="bi bi-arrows-expand"></i> Expand All
        </button>
        <button type="button" class="btn btn-outline-secondary me-2" id="collapseAllBtn">
            <i class="bi bi-arrows-collapse"></i> Collapse All
        </button>
        <a href="{% url 'budgeting:setup_coa_add' %}" class="btn btn-primary">
            <i class="bi bi-plus-lg"></i> Add Budget Head
        </a>
    </div>
</div>

<!-- Filters Section -->
<div class="filter-section mb-4">
    <form method="get" id="filterForm">
        <div class="row g-3">
            <div class="col-md-2">
                <label class="form-label fw-semibold small">Search</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" name="q" class="form-control" placeholder="Code or description..." value="{{ request.GET.q|default:'' }}">
                </div>
            </div>
            <div class="col-md-2">
                <label class="form-label fw-semibold small">Account Type</label>
                <select name="account_type" class="form-select">
                    <option value="">All Types</option>
                    {% for value, label in account_types %}
                    <option value="{{ value }}" {% if request.GET.account_type == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-1">
                <label class="form-label fw-semibold small">Fund</label>
                <select name="fund" class="form-select">
                    <option value="">All</option>
                    {% for fund in funds %}
                    <option value="{{ fund.id }}" {% if request.GET.fund|add:0 == fund.id %}selected{% endif %}>{{ fund.code }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-1">
                <label class="form-label fw-semibold small">Function</label>
                <select name="function" class="form-select">
                    <option value="">All</option>
                    {% for func in functions %}
                    <option value="{{ func.id }}" {% if request.GET.function|add:0 == func.id %}selected{% endif %}>{{ func.code }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-1">
                <label class="form-label fw-semibold small">Major</label>
                <select name="major_head" class="form-select">
                    <option value="">All</option>
                    {% for major in major_heads %}
                    <option value="{{ major }}" {% if request.GET.major_head == major %}selected{% endif %}>{{ major }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-1">
                <label class="form-label fw-semibold small">Minor</label>
                <select name="minor_head" class="form-select">
                    <option value="">All</option>
                    {% for minor in minor_heads %}
                    <option value="{{ minor }}" {% if request.GET.minor_head == minor %}selected{% endif %}>{{ minor }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label fw-semibold small">Status</label>
                <select name="is_active" class="form-select">
                    <option value="">All</option>
                    <option value="true" {% if request.GET.is_active == 'true' %}selected{% endif %}>Active Only</option>
                    <option value="false" {% if request.GET.is_active == 'false' %}selected{% endif %}>Inactive Only</option>
                </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-funnel"></i> Filter
                </button>
            </div>
        </div>
        {% if request.GET.q or request.GET.account_type or request.GET.fund or request.GET.function or request.GET.is_active or request.GET.major_head or request.GET.minor_head %}
        <div class="mt-2">
            <a href="{% url 'budgeting:setup_coa_list' %}" class="btn btn-sm btn-link text-decoration-none">
                <i class="bi bi-x-circle"></i> Clear Filters
            </a>
        </div>
        {% endif %}
    </form>
</div>

<div class="card shadow-sm">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <span class="fw-semibold">
            <i class="bi bi-table"></i> Budget Heads 
            <span class="badge bg-secondary ms-2">{{ tree_nodes|length }}</span>
        </span>
    </div>
    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0" id="coaTree">
            <thead class="table-light">
                <tr>
                    <th style="width: 35%;">Object Code / Description</th>
                    <th style="width: 15%;">Sub-Object</th>
                    <th style="width: 10%;">Fund</th>
                    <th style="width: 10%;">Function</th>
                    <th style="width: 12%;">Type</th>
                    <th class="text-center" style="width: 8%;">Status</th>
                    <th class="text-end" style="width: 10%;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for node in tree_nodes %}
                {% with head=node.obj %}
                <tr class="tree-row" data-level="{{ node.level }}" data-code="{{ head.pifra_object }}" data-parent="{{ node.parent_code|default:'' }}">
                    <td>
                        <div style="padding-left: calc({{ node.level }} * 1.5rem); display: flex; align-items: center;">
                            {% if node.has_children %}
                                <span class="tree-toggle expanded" data-code="{{ head.pifra_object }}"></span>
                            {% else %}
                                <span style="width: 20px; display: inline-block;"></span>
                            {% endif %}
                            
                            {% if not node.is_leaf %}
                                <i class="bi bi-folder2-open text-primary me-2" style="font-size: 1.1em;"></i>
                            {% else %}
                                <i class="bi bi-file-earmark-text text-muted me-2"></i>
                            {% endif %}
                            
                            <div>
                                <code class="text-primary fw-semibold">{{ head.pifra_object }}</code>
                                <div class="small text-muted mt-1">{{ head.tma_description|truncatewords:15 }}</div>
                            </div>
                        </div>
                    </td>
                    <td><span class="badge bg-light text-dark border">{{ head.tma_sub_object }}</span></td>
                    <td><small class="text-muted">{{ head.fund.code }}</small></td>
                    <td><small class="text-muted">{{ head.function.code|default:"—" }}</small></td>
                    <td>
                        <span class="badge badge-type-{{ head.account_type|lower }}">
                            {{ head.get_account_type_display }}
                        </span>
                    </td>
                    <td class="text-center">
                        {% if head.is_active %}
                            <i class="bi bi-check-circle-fill text-success" title="Active"></i>
                        {% else %}
                            <i class="bi bi-x-circle text-danger" title="Inactive"></i>
                        {% endif %}
                    </td>
                    <td class="text-end">
                        <div class="btn-group btn-group-sm">
                            <a href="{% url 'budgeting:setup_coa_edit' head.pk %}" class="btn btn-outline-primary" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </a>
                            <a href="{% url 'budgeting:setup_coa_delete' head.pk %}" class="btn btn-outline-danger" title="Delete" onclick="return confirm('Delete this budget head?')">
                                <i class="bi bi-trash"></i>
                            </a>
                        </div>
                    </td>
                </tr>
                {% endwith %}
                {% empty %}
                <tr>
                    <td colspan="7" class="text-center py-5 text-muted">
                        <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                        <div class="mt-2">No budget heads found matching your filters.</div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tree = document.getElementById('coaTree');
    if (!tree) return;
    
    // Toggle tree node
    function toggleNode(code, expand) {
        const rows = tree.querySelectorAll('tr[data-parent="' + code + '"]');
        rows.forEach(row => {
            const isCurrentlyHidden = row.classList.contains('tree-node-collapsed');
            
            if (expand && isCurrentlyHidden) {
                row.classList.remove('tree-node-collapsed');
            } else if (!expand && !isCurrentlyHidden) {
                row.classList.add('tree-node-collapsed');
                // Also collapse all descendants
                const childCode = row.dataset.code;
                toggleNode(childCode, false);
            }
        });
        
        // Update toggle icon
        const toggle = tree.querySelector('.tree-toggle[data-code="' + code + '"]');
        if (toggle) {
            if (expand) {
                toggle.classList.remove('collapsed');
                toggle.classList.add('expanded');
            } else {
                toggle.classList.remove('expanded');
                toggle.classList.add('collapsed');
            }
        }
    }
    
    // Attach click handlers to toggle buttons
    tree.querySelectorAll('.tree-toggle').forEach(toggle => {
        toggle.addEventListener('click', function(e) {
            e.stopPropagation();
            const code = this.dataset.code;
            const isExpanded = this.classList.contains('expanded');
            toggleNode(code, !isExpanded);
        });
    });
    
    // Expand all button
    document.getElementById('expandAllBtn')?.addEventListener('click', function() {
        tree.querySelectorAll('.tree-node-collapsed').forEach(row => {
            row.classList.remove('tree-node-collapsed');
        });
        tree.querySelectorAll('.tree-toggle').forEach(toggle => {
            toggle.classList.remove('collapsed');
            toggle.classList.add('expanded');
        });
    });
    
    // Collapse all button
    document.getElementById('collapseAllBtn')?.addEventListener('click', function() {
        // Collapse all except level 0
        tree.querySelectorAll('tr[data-level]').forEach(row => {
            const level = parseInt(row.dataset.level);
            if (level > 0) {
                row.classList.add('tree-node-collapsed');
            }
        });
        tree.querySelectorAll('.tree-toggle').forEach(toggle => {
            toggle.classList.remove('expanded');
            toggle.classList.add('collapsed');
        });
    });
    
    // Auto-submit on filter change
    const filterSelects = document.querySelectorAll('#filterForm select');
    filterSelects.forEach(select => {
        select.addEventListener('change', function() {
            document.getElementById('filterForm').submit();
        });
    });
});
</script>
{% endblock %}
