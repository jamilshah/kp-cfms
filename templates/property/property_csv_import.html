{% extends "base.html" %}

{% block title %}Import Properties from CSV - KP-CFMS{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card shadow-sm">
            <div class="card-header bg-white py-3 border-bottom">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0 text-primary">
                        <i class="bi bi-file-earmark-spreadsheet me-2"></i>Bulk Import Properties from CSV
                    </h4>
                    <a href="{% url 'property:list' %}" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-arrow-left me-1"></i>Back to Properties
                    </a>
                </div>
            </div>
            
            <div class="card-body p-4">
                {% if errors %}
                <div class="alert alert-danger">
                    <h5><i class="bi bi-exclamation-triangle me-2"></i>Import Errors ({{ error_count }})</h5>
                    <ul class="mb-0">
                        {% for error in errors %}
                        <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                    <p class="mt-3 mb-0">
                        <strong>{{ success_count }} properties</strong> were successfully validated before the error occurred.
                        No changes have been saved. Please fix the errors and try again.
                    </p>
                </div>
                {% endif %}
                
                {% if warnings %}
                <div class="alert alert-warning">
                    <h5><i class="bi bi-exclamation-triangle-fill me-2"></i>Warnings ({{ warning_count }})</h5>
                    <ul class="mb-0">
                        {% for warning in warnings %}
                        <li>{{ warning }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
                
                {% if success_count > 0 and not errors %}
                <div class="alert alert-success">
                    <h5><i class="bi bi-check-circle me-2"></i>Import Successful!</h5>
                    <p class="mb-0">
                        <strong>{{ success_count }} properties</strong> have been successfully imported.
                        {% if update_count > 0 %}({{ update_count }} updated, {{ success_count|add:"-"|add:update_count }} newly created){% endif %}
                    </p>
                </div>
                {% endif %}
                
                <!-- Instructions -->
                <div class="alert alert-info mb-4">
                    <h5><i class="bi bi-info-circle me-2"></i>Instructions</h5>
                    <ol class="mb-2">
                        <li><strong>Download the template</strong> by clicking the button below</li>
                        <li><strong>Fill in the property data</strong> using Excel/Google Sheets:
                            <ul class="mt-2">
                                <li><strong>Office Name:</strong> TMA/Organization name (e.g., "TMA Peshawar", "Capital Metropolitan")</li>
                                <li><strong>District Name:</strong> District name (must exist in system)</li>
                                <li><strong>Property Name:</strong> Name/identifier for the property</li>
                                <li><strong>Address:</strong> Full address of the property</li>
                                <li><strong>Mauza:</strong> Mauza name (will be created if doesn't exist)</li>
                                <li><strong>Village:</strong> Village name (optional, will be created if doesn't exist)</li>
                                <li><strong>Coordinates:</strong> Lat,Long format (e.g., 34.0151,71.5249)</li>
                                <li><strong>Property Type:</strong> Commercial, Residential, Agricultural, Industrial, Mixed, or Other</li>
                                <li><strong>Area (in Sq Metres):</strong> Numeric value</li>
                                <li><strong>Status:</strong> "Rented Out", "Vacant", "Self Use", "Under Construction", "Under Litigation", "Encroached", or "Demolished"</li>
                                <li><strong>Annual Rent:</strong> Numeric value (0 if not applicable)</li>
                                <li><strong>Court Case Title:</strong> Enter "Nil" if no court case, otherwise enter case title</li>
                                <li><strong>Remarks:</strong> Optional additional notes</li>
                            </ul>
                        </li>
                        <li><strong>Save as CSV</strong> format</li>
                        <li><strong>Upload the file</strong> using the form below</li>
                    </ol>
                    <div class="alert alert-warning mb-0 mt-3">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        <strong>Important:</strong> The system will validate coordinates, property types, and existing records. 
                        Properties with the same name and mauza will be updated instead of creating duplicates.
                        <strong>Mauzas and Villages will be automatically created if they don't exist in the system.</strong>
                    </div>
                </div>
                
                <!-- Download Template Button -->
                <div class="text-center mb-4 p-4 bg-light rounded">
                    <a href="{% url 'property:csv_template' %}" class="btn btn-success btn-lg">
                        <i class="bi bi-download me-2"></i>Download CSV Template
                    </a>
                    <p class="text-muted mt-2 mb-0">
                        <small>The template includes an example row to help you get started</small>
                    </p>
                </div>
                
                <!-- Upload Form -->
                <form method="post" enctype="multipart/form-data" class="border p-4 rounded">
                    {% csrf_token %}
                    
                    <div class="mb-4">
                        <label for="csv_file" class="form-label">
                            <strong>Select CSV File</strong>
                        </label>
                        <input type="file" 
                               name="csv_file" 
                               id="csv_file" 
                               class="form-control" 
                               accept=".csv"
                               required>
                        <div class="form-text">
                            Only CSV files are accepted. Maximum file size: 10MB
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-end gap-2">
                        <a href="{% url 'property:list' %}" class="btn btn-light border">Cancel</a>
                        <button type="submit" class="btn btn-primary px-4">
                            <i class="bi bi-upload me-1"></i>Import Properties
                        </button>
                    </div>
                </form>
                
                <!-- Tips -->
                <div class="mt-4">
                    <h5>Tips for Success</h5>
                    <ul>
                        <li><strong>Organizations must exist first</strong> - Create TMAs/Organizations in system before importing properties</li>
                        <li><strong>District must exist</strong> - Districts must be set up in the admin area structure</li>
                        <li><strong>Mauza & Village auto-creation</strong> - If a Mauza or Village doesn't exist, it will be automatically created (warnings will be shown)</li>
                        <li><strong>Coordinates format:</strong> Latitude,Longitude (e.g., 34.0151,71.5249) - no spaces</li>
                        <li><strong>Property Type values:</strong> Must match exactly: Commercial, Residential, Agricultural, Industrial, Mixed, or Other</li>
                        <li><strong>Status values:</strong> Must match: Rented Out, Vacant, Self Use, Under Construction, Under Litigation, Encroached, or Demolished</li>
                        <li><strong>Court Cases:</strong> Enter "Nil" (case insensitive) if no case, otherwise enter the case title</li>
                        <li><strong>Annual Rent:</strong> Enter 0 for properties without rent, or the actual amount</li>
                        <li><strong>Updates vs Creates:</strong> Properties with matching name+mauza+district will be updated; new combinations create new records</li>
                        <li><strong>Test first:</strong> Import a small file (5-10 rows) before importing large datasets</li>
                        <li><strong>Optional fields:</strong> Village, Photo URL, Encroachment details, and Remarks can be left blank</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
